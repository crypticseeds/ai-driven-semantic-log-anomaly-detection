name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          uv sync --dev

      - name: Run Config Tests (test_config.py)
        timeout-minutes: 2
        run: |
          echo "=== Running Configuration Tests ==="
          uv run python -m pytest backend/tests/test_config.py -v --tb=short --durations=10

      - name: Run PII Service Unit Tests (test_pii_service.py)
        timeout-minutes: 3
        run: |
          echo "=== Running PII Service Unit Tests ==="
          uv run python -m pytest backend/tests/unit/test_pii_service.py -v --tb=short --durations=10

      # TODO: Fix Kafka Service Unit Tests - see Linear issue
      # - name: Run Unit Tests (test_kafka_service.py)
      #   timeout-minutes: 3
      #   run: |
      #     echo "=== Running Kafka Service Unit Tests ==="
      #     uv run python -m pytest backend/tests/unit/test_kafka_service.py -v --tb=short --durations=10

      - name: Run Integration Tests (test_ingestion_flow.py)
        timeout-minutes: 5
        run: |
          echo "=== Running Ingestion Flow Integration Tests ==="
          uv run python -m pytest backend/tests/integration/test_ingestion_flow.py -v --tb=short --durations=10

      - name: Generate Coverage Report (All Tests)
        timeout-minutes: 10
        continue-on-error: true
        run: |
          echo "=== Generating Coverage Report for All Tests ==="
          # Exclude Kafka tests until they are fixed - see Linear issue
          uv run python -m pytest backend/tests --ignore=backend/tests/unit/test_kafka_service.py --cov=backend/app --cov-report=xml --cov-report=html --tb=short --durations=10 -q

      - name: Upload coverage reports
        uses: codecov/codecov-action@v5
        if: always() && hashFiles('coverage.xml') != ''
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

